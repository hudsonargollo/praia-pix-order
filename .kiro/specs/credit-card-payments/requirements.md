# Requirements Document

## Introduction

This document outlines the requirements for integrating credit card payments into the existing checkout flow. This feature will be added alongside the current PIX payment option, leveraging the MercadoPago API and its "Payment Brick" (Checkout Transparente) to provide a secure, embedded payment form. The goal is to offer customers a choice of payment methods and increase conversion by accepting major credit cards for single, one-time payments only.

## Glossary

- **Payment Page**: The page where customers complete payment. This page will now host multiple payment methods.
- **PIX**: The existing instant payment method.
- **Credit Card**: The new payment method to be added (e.g., Visa, Mastercard) for one-time payments.
- **MercadoPago Payment Brick**: A pre-built UI component from MercadoPago that securely collects card information (number, expiration, CVV, holder details) within the store's page.
- **Card Token**: A secure, one-time-use string generated by MercadoPago.js representing the customer's card details. This token is safely sent to the backend instead of the raw card data.
- **Backend Payment Endpoint**: A secure server-side function that receives the Card Token and other order details to create the payment charge via the MercadoPago API.
- **Payment System**: The overall system handling payment processing, including both PIX and credit card methods.
- **Order**: A customer's purchase request containing items, total amount, and payment information.

## Requirements

### Requirement 1: Payment Method Selection

**User Story:** As a customer on the payment page, I want to clearly see and choose between paying with PIX or paying with a Credit Card, so I can select my preferred method.

#### Acceptance Criteria

1. THE Payment Page SHALL display options to select the payment method.
2. THE options SHALL include "PIX" and "Cartão de Crédito".
3. WHEN the Payment Page loads, THE Payment System SHALL set "PIX" as the default selected method.
4. WHILE "PIX" is selected, THE Payment Page SHALL display the existing PIX flow interface including Copy-Paste code and QR code.
5. WHEN the customer selects "Cartão de Crédito", THE Payment Page SHALL hide the PIX payment interface and display the Credit Card payment interface.
6. WHEN the customer switches back to "PIX", THE Payment Page SHALL hide the Credit Card interface and display the PIX interface.
7. THE Payment Page SHALL display the "Resumo do Pedido" (Order Summary) card regardless of the selected payment method.

### Requirement 2: Credit Card Form (Payment Brick)

**User Story:** As a customer paying with a credit card, I want to see a secure and easy-to-use form to enter my card details directly on the payment page.

#### Acceptance Criteria

1. WHEN "Cartão de Crédito" is selected, THE Payment System SHALL initialize and render the MercadoPago Card Payment Brick.
2. THE Payment Page SHALL embed the Payment Brick directly into the page layout, below the payment method selector and above the "Resumo do Pedido" card.
3. THE Payment Brick SHALL provide fields for Card Number, Cardholder Name, Expiration Date (MM/YY), Security Code (CVV/CVC), Cardholder Document Type (e.g., CPF), and Cardholder Document Number.
4. THE Payment Brick SHALL NOT display any options for installments (parcelamento).
5. THE Payment Page SHALL load the MercadoPago.js script to support the Payment Brick functionality.

### Requirement 3: Payment Submission & Tokenization

**User Story:** As a customer, when I click "Pagar com Cartão", I want my payment to be processed securely without my sensitive card details being sent to the store's server.

#### Acceptance Criteria

1. WHEN the credit card method is selected, THE Payment Page SHALL display a primary button labeled "Pagar com Cartão".
2. WHEN the customer clicks "Pagar com Cartão", THE Payment System SHALL call the MercadoPago.js SDK to create a secure Card Token from the Payment Brick's data.
3. WHILE tokenization is in progress, THE Payment Page SHALL display a loading indicator and disable the "Pagar com Cartão" button to prevent multiple submissions.
4. IF tokenization fails, THE Payment Brick SHALL display the specific error message to the customer (e.g., "Número de cartão inválido").
5. IF tokenization is successful, THE Payment System SHALL send the generated Card Token and order ID to the backend payment endpoint.
6. THE Payment System SHALL NOT send raw credit card numbers or CVVs to the backend.

### Requirement 4: Backend Payment Processing

**User Story:** As the system, I need to receive the secure token and order details to create a single, one-time charge using the MercadoPago API.

#### Acceptance Criteria

1. THE Payment System SHALL provide a secure backend endpoint at /api/mercadopago/create-card-payment.
2. THE backend endpoint SHALL receive the Card Token, order_id, total_amount, and payer information (including document number) from the frontend.
3. THE backend endpoint SHALL use the MercadoPago Server-Side SDK to make a "create payment" request to the /v1/payments API endpoint.
4. THE payment request SHALL include transaction_amount, token, payment_method_id, payer details, and explicitly set installments to 1.
5. THE backend endpoint SHALL update the orders table in the database with the payment status returned by MercadoPago (e.g., approved, in_process, rejected).
6. THE backend endpoint SHALL return a clear JSON response to the frontend indicating the final payment status (success, pending, or error).

### Requirement 5: Payment Status and Error Handling

**User Story:** As a customer, after submitting my card details, I want to immediately see if my payment was approved, declined, or is pending.

#### Acceptance Criteria

1. THE Payment Page SHALL update the "Status do pagamento" badge in real-time based on the response from the backend.
2. IF the payment is approved (Pago), THE Payment Page SHALL update the status badge accordingly, hide or disable the credit card form, and display a success message.
3. IF the payment is rejected (Recusado), THE Payment Page SHALL update the status badge to show an error (e.g., "Pagamento Rejeitado"), display a toast notification or inline message with the reason for rejection (e.g., "Pagamento recusado pelo banco", "Fundos insuficientes"), and re-enable the "Pagar com Cartão" button for retry.
4. IF the payment is in_process (Pendente), THE Payment Page SHALL update the status badge to "Pendente" and display a message informing the customer that the payment is under review.
